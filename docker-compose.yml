services:
  infra:
    build:
      context: ./infra
      target: infra-app
    image: infra-app
    env_file:
      - .env
    volumes:
      - type: bind
        source: ./infra
        target: /home/appuser/app
    networks:
      - default-net
    command: >
      sh -c "
      cdk bootstrap aws://${AWS_ACCOUNT_ID}/${AWS_DEFAULT_REGION} &&
      cdk deploy DataPlatform --app 'python3 app.py' --require-approval never
      "

  ingestion:
    build:
      context: ./ingestion
      target: ingestion-app
    image: ingestion-app
    env_file:
      - .env
    volumes:
      - type: bind
        source: ./ingestion
        target: /home/appuser/app
    networks:
      - default-net

  dbt:
    build:
      context: ./transformation_dbt
      target: dbt-app
    image: dbt-app
    env_file:
      - .env
    volumes:
      - type: bind
        source: ./transformation_dbt
        target: /home/appuser/app
    networks:
      - default-net

volumes:
  default-volume:

networks:
  default-net: